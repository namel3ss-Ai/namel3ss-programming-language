name: Deploy to Production

on:
  push:
    tags: [ 'v*' ]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to deploy (e.g., v1.0.0)'
        required: true
        type: string

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository }}

jobs:
  deploy-production:
    name: Deploy to Production Environment
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://n3-graph-editor.com
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.version || github.ref }}
      
      - name: Extract version
        id: version
        run: |
          if [ "${{ inputs.version }}" != "" ]; then
            echo "version=${{ inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi
      
      - name: Set up kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'latest'
      
      - name: Configure Kubernetes context
        uses: azure/k8s-set-context@v3
        with:
          method: kubeconfig
          kubeconfig: ${{ secrets.KUBE_CONFIG_PRODUCTION }}
      
      - name: Create namespace if not exists
        run: |
          kubectl create namespace n3-production --dry-run=client -o yaml | kubectl apply -f -
      
      - name: Create Docker registry secret
        run: |
          kubectl create secret docker-registry ghcr-secret \
            --docker-server=${{ env.REGISTRY }} \
            --docker-username=${{ github.actor }} \
            --docker-password=${{ secrets.GITHUB_TOKEN }} \
            --namespace=n3-production \
            --dry-run=client -o yaml | kubectl apply -f -
      
      - name: Create ConfigMap
        run: |
          kubectl create configmap n3-config \
            --from-literal=DATABASE_URL=${{ secrets.PRODUCTION_DATABASE_URL }} \
            --from-literal=SECRET_KEY=${{ secrets.PRODUCTION_SECRET_KEY }} \
            --from-literal=CORS_ORIGINS='["https://n3-graph-editor.com"]' \
            --namespace=n3-production \
            --dry-run=client -o yaml | kubectl apply -f -
      
      - name: Backup database
        run: |
          # Trigger database backup before deployment
          kubectl exec -n n3-production deployment/postgres -- \
            pg_dump -U n3 n3_graphs > backup-$(date +%Y%m%d-%H%M%S).sql
      
      - name: Deploy to Kubernetes
        run: |
          # Replace image tags with version
          VERSION=${{ steps.version.outputs.version }}
          sed -i "s|IMAGE_TAG|$VERSION|g" k8s/production/*.yaml
          
          # Apply Kubernetes manifests
          kubectl apply -f k8s/production/ --namespace=n3-production
      
      - name: Wait for rollout
        run: |
          kubectl rollout status deployment/backend --namespace=n3-production --timeout=10m
          kubectl rollout status deployment/frontend --namespace=n3-production --timeout=10m
          kubectl rollout status deployment/yjs-server --namespace=n3-production --timeout=10m
      
      - name: Run smoke tests
        run: |
          PROD_URL=https://n3-graph-editor.com
          
          # Health check
          curl -f $PROD_URL/api/health || exit 1
          
          # Basic API test
          curl -f $PROD_URL/api/projects || exit 1
          
          # Authentication test
          TOKEN=$(curl -s -X POST $PROD_URL/api/auth/login \
            -H "Content-Type: application/json" \
            -d '{"username":"${{ secrets.SMOKE_TEST_USER }}","password":"${{ secrets.SMOKE_TEST_PASSWORD }}"}' \
            | jq -r .access_token)
          
          curl -f -H "Authorization: Bearer $TOKEN" $PROD_URL/api/auth/me || exit 1
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          generate_release_notes: true
          draft: false
          prerelease: false
      
      - name: Notify deployment success
        if: success()
        uses: 8398a7/action-slack@v3
        with:
          status: 'success'
          text: '✅ Production deployment ${{ steps.version.outputs.version }} successful'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
      
      - name: Notify deployment failure
        if: failure()
        uses: 8398a7/action-slack@v3
        with:
          status: 'failure'
          text: '❌ Production deployment ${{ steps.version.outputs.version }} failed'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
      
      - name: Rollback on failure
        if: failure()
        run: |
          echo "Rolling back to previous version..."
          kubectl rollout undo deployment/backend --namespace=n3-production
          kubectl rollout undo deployment/frontend --namespace=n3-production
          kubectl rollout undo deployment/yjs-server --namespace=n3-production
