name: Deploy to Staging

on:
  push:
    branches: [ develop ]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository }}

jobs:
  deploy-staging:
    name: Deploy to Staging Environment
    runs-on: ubuntu-latest
    environment:
      name: staging
      url: https://staging.n3-graph-editor.com
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'latest'
      
      - name: Configure Kubernetes context
        uses: azure/k8s-set-context@v3
        with:
          method: kubeconfig
          kubeconfig: ${{ secrets.KUBE_CONFIG_STAGING }}
      
      - name: Create namespace if not exists
        run: |
          kubectl create namespace n3-staging --dry-run=client -o yaml | kubectl apply -f -
      
      - name: Create Docker registry secret
        run: |
          kubectl create secret docker-registry ghcr-secret \
            --docker-server=${{ env.REGISTRY }} \
            --docker-username=${{ github.actor }} \
            --docker-password=${{ secrets.GITHUB_TOKEN }} \
            --namespace=n3-staging \
            --dry-run=client -o yaml | kubectl apply -f -
      
      - name: Create ConfigMap
        run: |
          kubectl create configmap n3-config \
            --from-literal=DATABASE_URL=${{ secrets.STAGING_DATABASE_URL }} \
            --from-literal=SECRET_KEY=${{ secrets.STAGING_SECRET_KEY }} \
            --from-literal=CORS_ORIGINS='["https://staging.n3-graph-editor.com"]' \
            --namespace=n3-staging \
            --dry-run=client -o yaml | kubectl apply -f -
      
      - name: Deploy to Kubernetes
        run: |
          # Replace image tags in manifests
          sed -i "s|IMAGE_TAG|${{ github.sha }}|g" k8s/staging/*.yaml
          
          # Apply Kubernetes manifests
          kubectl apply -f k8s/staging/ --namespace=n3-staging
      
      - name: Wait for rollout
        run: |
          kubectl rollout status deployment/backend --namespace=n3-staging --timeout=5m
          kubectl rollout status deployment/frontend --namespace=n3-staging --timeout=5m
          kubectl rollout status deployment/yjs-server --namespace=n3-staging --timeout=5m
      
      - name: Run smoke tests
        run: |
          STAGING_URL=https://staging.n3-graph-editor.com
          
          # Health check
          curl -f $STAGING_URL/api/health || exit 1
          
          # Basic API test
          curl -f $STAGING_URL/api/projects || exit 1
      
      - name: Notify deployment
        if: always()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: 'Staging deployment ${{ job.status }}'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
