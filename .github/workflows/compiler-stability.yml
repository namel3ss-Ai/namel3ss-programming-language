name: Compiler Stability CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  core-stability:
    name: Core Compiler Stability Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.10", "3.11", "3.12"]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Cache dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt', 'requirements-dev.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .
        pip install -r requirements-dev.txt
    
    - name: Run validation tests
      run: |
        pytest tests/test_cli_validation.py -v --tb=short
      continue-on-error: false
    
    - name: Run official examples build tests
      run: |
        pytest tests/test_official_examples.py -v --tb=short -m "not slow"
      continue-on-error: false
    
    - name: Run parser tests
      run: |
        pytest tests/test_parser*.py -v --tb=short
      continue-on-error: true  # Allow parser tests to fail during stabilization
    
    - name: Run codegen tests
      run: |
        pytest tests/test_codegen*.py -v --tb=short
      continue-on-error: true  # Allow codegen tests to fail during stabilization

  determinism-check:
    name: Build Determinism Check
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .
    
    - name: Test build determinism
      run: |
        pytest tests/test_official_examples.py::TestDeterminism -v --tb=short
      continue-on-error: false

  type-checking:
    name: Type Checking (mypy)
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .
        pip install mypy types-requests
    
    - name: Run mypy
      run: |
        mypy namel3ss/ --ignore-missing-imports --no-strict-optional
      continue-on-error: true  # Non-blocking during stabilization

  linting:
    name: Code Linting (ruff)
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"
    
    - name: Install ruff
      run: |
        python -m pip install --upgrade pip
        pip install ruff
    
    - name: Run ruff check
      run: |
        ruff check namel3ss/ --select E,F,W --ignore E501
      continue-on-error: true  # Non-blocking during stabilization
    
    - name: Run ruff format check
      run: |
        ruff format --check namel3ss/
      continue-on-error: true

  integration-tests:
    name: End-to-End Integration Tests
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .
    
    - name: Test demo_app.n3 builds
      run: |
        python -c "
from pathlib import Path
from namel3ss.parser import Parser
from namel3ss.codegen.backend.core import generate_backend
from namel3ss.codegen.frontend import generate_site
import tempfile

# Parse demo_app.n3
with open('demo_app.n3', 'r') as f:
    content = f.read()

parser = Parser()
ast = parser.parse(content)

# Generate backend
with tempfile.TemporaryDirectory() as tmpdir:
    backend_dir = Path(tmpdir) / 'backend'
    backend_dir.mkdir()
    generate_backend(ast, str(backend_dir))
    
    # Verify main.py exists
    assert (backend_dir / 'main.py').exists(), 'Backend main.py not generated'
    
    # Verify runtime.py exists
    assert (backend_dir / 'runtime.py').exists(), 'Backend runtime.py not generated'

print('✓ demo_app.n3 builds successfully')
        "
    
    - name: Test CLI build command
      run: |
        # Test that CLI doesn't crash (even if build fails)
        python -m namel3ss.cli build demo_app.n3 --help || true

  release-check:
    name: Release Readiness Check
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Check version consistency
      run: |
        python -c "
import tomli
from pathlib import Path

# Read version from pyproject.toml
with open('pyproject.toml', 'rb') as f:
    pyproject = tomli.load(f)
    toml_version = pyproject['project']['version']

# Read version from __init__.py
init_content = Path('namel3ss/__init__.py').read_text()
for line in init_content.split('\n'):
    if '__version__' in line:
        init_version = line.split('=')[1].strip().strip('\"\'')
        break
else:
    init_version = None

print(f'pyproject.toml version: {toml_version}')
print(f'__init__.py version: {init_version}')

if toml_version != init_version:
    print('❌ Version mismatch!')
    exit(1)
else:
    print('✓ Versions match')
        " || true
    
    - name: Check CHANGELOG.md updated
      run: |
        python -c "
from pathlib import Path
import tomli

# Get current version
with open('pyproject.toml', 'rb') as f:
    version = tomli.load(f)['project']['version']

# Check if version is in CHANGELOG
if Path('CHANGELOG.md').exists():
    changelog = Path('CHANGELOG.md').read_text()
    if version in changelog:
        print(f'✓ Version {version} found in CHANGELOG.md')
    else:
        print(f'⚠ Version {version} not found in CHANGELOG.md')
else:
    print('⚠ CHANGELOG.md not found')
        " || true

  summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [core-stability, determinism-check]
    if: always()
    
    steps:
    - name: Check core stability
      if: needs.core-stability.result != 'success'
      run: |
        echo "❌ Core stability tests failed"
        exit 1
    
    - name: Check determinism
      if: needs.determinism-check.result != 'success'
      run: |
        echo "❌ Determinism check failed"
        exit 1
    
    - name: Success
      if: needs.core-stability.result == 'success' && needs.determinism-check.result == 'success'
      run: |
        echo "✓ All critical tests passed"
