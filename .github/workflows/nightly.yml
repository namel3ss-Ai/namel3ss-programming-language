# Nightly health check for Namel3ss
# Runs comprehensive tests daily to catch any regressions or issues
# Also verifies that the CLI entrypoint is working correctly
# Can be triggered manually for on-demand health checks

name: Nightly Health Check

on:
  schedule:
    # Run at 3 AM UTC every day
    - cron: "0 3 * * *"
  workflow_dispatch:

permissions:
  contents: read

jobs:
  test:
    name: Health Check - Python ${{ matrix.python-version }}
    runs-on: ubuntu-latest
    
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.10", "3.11", "3.12"]
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]" || (pip install -e . && pip install pytest pytest-cov)
      
      - name: Run full test suite
        run: |
          pytest --verbose --tb=short --maxfail=5
      
      - name: Verify CLI installation
        run: |
          namel3ss --version
          namel3ss --help
  
  cli-smoke-test:
    name: CLI Smoke Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: 'pip'
      
      - name: Install package
        run: |
          python -m pip install --upgrade pip
          pip install -e .
      
      - name: Test CLI commands
        run: |
          # Test basic commands
          namel3ss --version
          namel3ss --help
          
          # Test init command
          namel3ss init --help
          
          # Test sync-deps command
          namel3ss sync-deps --help
          namel3ss sync-deps --list-features || true
          
          # Test build command
          namel3ss build --help
      
      - name: Report status
        if: failure()
        run: |
          echo "::error::Nightly health check failed! CLI commands are not working correctly."
