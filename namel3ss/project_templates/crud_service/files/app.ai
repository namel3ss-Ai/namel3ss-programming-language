# ðŸ’¬ {{ project_name }} - N3 Configuration
# ðŸ’¬ This file demonstrates N3 DSL integration with the CRUD service

# ðŸ’¬ ============================================================================
# ðŸ’¬ DATASET DEFINITION
# ðŸ’¬ ============================================================================

dataset {{ dataset_name }} {
    name: "{{ entity_name }} Management"
    description: "CRUD operations for {{ entity_name | lower }} entities"
    version: "1.0.0"

    # ðŸ’¬ Entity schema definition
    schema {
        id: uuid(primary_key: true, auto: true)
        name: string(required: true, min_length: 1, max_length: 255)
        description: string(max_length: 2000)
        quantity: integer(default: 0, min: 0)
        price: decimal(precision: 10, scale: 2, default: 0.00, min: 0)
        is_active: boolean(default: true)
        tags: array(string, max_length: 20)
        metadata: json()
        created_at: timestamp(auto_now_add: true)
        updated_at: timestamp(auto_now: true)
        deleted_at: timestamp(nullable: true)
        tenant_id: string(nullable: true, max_length: 255)
    }

    # ðŸ’¬ Indexes for query optimization
    indexes {
        idx_name: [name]
        idx_active: [is_active, created_at]
        idx_tenant: [tenant_id]
        idx_tags: [tags] (type: gin)
        idx_metadata: [metadata] (type: gin)
    }

    # ðŸ’¬ Validation rules
    validation {
        # ðŸ’¬ Name must not be empty
        rule "name_not_empty" {
            field: name
            condition: name.length > 0
            message: "Name cannot be empty"
        }

        # ðŸ’¬ Price precision validation
        rule "price_precision" {
            field: price
            condition: price.decimal_places <= 2
            message: "Price must have at most 2 decimal places"
        }

        # ðŸ’¬ Tags format validation
        rule "tags_alphanumeric" {
            field: tags
            condition: all(tags, tag => tag.length > 0)
            message: "Tags must be non-empty"
        }
    }
}

# ðŸ’¬ ============================================================================
# ðŸ’¬ API CONFIGURATION
# ðŸ’¬ ============================================================================

api {{ api_name }} {
    dataset: {{ dataset_name }}
    base_path: "/{{ endpoint_prefix }}"
    version: "v1"

    # ðŸ’¬ Enable standard CRUD operations
    operations {
        create: true
        read: true
        update: true
        delete: true
        list: true
        search: true
    }

    # ðŸ’¬ Pagination settings
    pagination {
        default_page_size: 20
        max_page_size: 100
    }

    # ðŸ’¬ Filtering capabilities
    filters {
        is_active: boolean
        tags: array(string)
        created_at: timestamp(range: true)
        price: decimal(range: true)
    }

    # ðŸ’¬ Sorting options
    sorting {
        fields: [name, created_at, updated_at, price, quantity]
        default: [created_at: desc]
    }

    # ðŸ’¬ Multi-tenancy support
    multi_tenancy {
        enabled: false  # ðŸ’¬ Set to true to enable
        tenant_field: tenant_id
        tenant_header: "X-Tenant-ID"
    }

    # ðŸ’¬ Soft delete configuration
    soft_delete {
        enabled: true
        field: deleted_at
    }
}

# ðŸ’¬ ============================================================================
# ðŸ’¬ BACKEND CONFIGURATION
# ðŸ’¬ ============================================================================

backend {{ backend_name }} {
    api: {{ api_name }}
    framework: "fastapi"
    language: "python"

    # ðŸ’¬ Database configuration
    database {
        type: "postgresql"
        pool_size: 10
        max_overflow: 20
        pool_timeout: 30
        echo: false  # ðŸ’¬ Set to true for SQL query logging
    }

    # ðŸ’¬ Server configuration
    server {
        host: "0.0.0.0"
        port: 8000
        workers: 1  # ðŸ’¬ Increase for production
        reload: true  # ðŸ’¬ Set to false for production
    }

    # ðŸ’¬ CORS configuration
    cors {
        enabled: true
        origins: ["http://localhost:3000", "http://localhost:8000"]
        allow_credentials: true
        allow_methods: ["*"]
        allow_headers: ["*"]
    }

    # ðŸ’¬ Logging configuration
    logging {
        level: "INFO"  # ðŸ’¬ DEBUG, INFO, WARNING, ERROR, CRITICAL
        format: "json"  # ðŸ’¬ json or text
    }

    # ðŸ’¬ Security (extension points)
    security {
        # ðŸ’¬ authentication {
        # ðŸ’¬ type: "jwt"
        # ðŸ’¬ secret_key: env("JWT_SECRET_KEY")
        # ðŸ’¬ algorithm: "HS256"
        # ðŸ’¬ token_expiry: 3600
        # ðŸ’¬ }

        # ðŸ’¬ api_key {
        # ðŸ’¬ enabled: false
        # ðŸ’¬ header: "X-API-Key"
        # ðŸ’¬ }
    }

    # ðŸ’¬ Observability (extension points)
    observability {
        # ðŸ’¬ metrics {
        # ðŸ’¬ enabled: true
        # ðŸ’¬ endpoint: "/metrics"
        # ðŸ’¬ provider: "prometheus"
        # ðŸ’¬ }

        # ðŸ’¬ tracing {
        # ðŸ’¬ enabled: false
        # ðŸ’¬ provider: "opentelemetry"
        # ðŸ’¬ endpoint: env("OTEL_EXPORTER_OTLP_ENDPOINT")
        # ðŸ’¬ }

        health_check {
            enabled: true
            endpoint: "/health"
        }
    }
}

# ðŸ’¬ ============================================================================
# ðŸ’¬ DEPLOYMENT CONFIGURATION (Optional)
# ðŸ’¬ ============================================================================

# ðŸ’¬ deployment production {
# ðŸ’¬ backend: {{ backend_name }}
# ðŸ’¬ platform: "docker"
# ðŸ’¬
# ðŸ’¬ container {
# ðŸ’¬ image: "{{ project_name | lower | replace('_', '-') }}:latest"
# ðŸ’¬ port: 8000
# ðŸ’¬ replicas: 3
# ðŸ’¬
# ðŸ’¬ resources {
# ðŸ’¬ cpu: "500m"
# ðŸ’¬ memory: "512Mi"
# ðŸ’¬ cpu_limit: "1000m"
# ðŸ’¬ memory_limit: "1Gi"
# ðŸ’¬ }
# ðŸ’¬
# ðŸ’¬ health_check {
# ðŸ’¬ path: "/health"
# ðŸ’¬ interval: 30
# ðŸ’¬ timeout: 5
# ðŸ’¬ retries: 3
# ðŸ’¬ }
# ðŸ’¬ }
# ðŸ’¬
# ðŸ’¬ database {
# ðŸ’¬ host: env("DB_HOST")
# ðŸ’¬ port: 5432
# ðŸ’¬ name: env("DB_NAME")
# ðŸ’¬ user: env("DB_USER")
# ðŸ’¬ password: env("DB_PASSWORD")
# ðŸ’¬ ssl: true
# ðŸ’¬ }
# ðŸ’¬
# ðŸ’¬ environment {
# ðŸ’¬ ENVIRONMENT: "production"
# ðŸ’¬ LOG_LEVEL: "INFO"
# ðŸ’¬ DEBUG: "false"
# ðŸ’¬ }
# ðŸ’¬ }

# ðŸ’¬ ============================================================================
# ðŸ’¬ EXTENSION EXAMPLES
# ðŸ’¬ ============================================================================

# ðŸ’¬ Example: Custom business logic hook
# ðŸ’¬ hook before_create {
# ðŸ’¬ dataset: {{ dataset_name }}
# ðŸ’¬
# ðŸ’¬ execute {
# ðŸ’¬ Normalize tags to lowercase
# ðŸ’¬ item.tags = item.tags.map(tag => tag.lower())
# ðŸ’¬
# ðŸ’¬ Set default metadata
# ðŸ’¬ if item.metadata is empty {
# ðŸ’¬ item.metadata = {"source": "api", "version": "1.0"}
# ðŸ’¬ }
# ðŸ’¬ }
# ðŸ’¬ }

# ðŸ’¬ Example: Custom validation
# ðŸ’¬ validator price_validation {
# ðŸ’¬ dataset: {{ dataset_name }}
# ðŸ’¬ field: price
# ðŸ’¬
# ðŸ’¬ rule {
# ðŸ’¬ if item.quantity > 100 and item.price < 10.00 {
# ðŸ’¬ error("High quantity items must have price >= $10.00")
# ðŸ’¬ }
# ðŸ’¬ }
# ðŸ’¬ }

# ðŸ’¬ Example: Event handler
# ðŸ’¬ event item_created {
# ðŸ’¬ dataset: {{ dataset_name }}
# ðŸ’¬ trigger: after_create
# ðŸ’¬
# ðŸ’¬ action {
# ðŸ’¬ Log to external service
# ðŸ’¬ log.info("New item created", {
# ðŸ’¬ id: item.id,
# ðŸ’¬ name: item.name,
# ðŸ’¬ tenant: item.tenant_id
# ðŸ’¬ })
# ðŸ’¬
# ðŸ’¬ Send notification
# ðŸ’¬ notify.send("items.created", item)
# ðŸ’¬ }
# ðŸ’¬ }

# ðŸ’¬ Example: Scheduled task
# ðŸ’¬ task cleanup_deleted_items {
# ðŸ’¬ dataset: {{ dataset_name }}
# ðŸ’¬ schedule: "0 0 * * *" â€” Daily at midnight
# ðŸ’¬
# ðŸ’¬ execute {
# ðŸ’¬ Hard delete items soft-deleted > 30 days ago
# ðŸ’¬ cutoff_date = now() - days(30)
# ðŸ’¬ deleted_items = {{ dataset_name }}.filter(
# ðŸ’¬ deleted_at < cutoff_date
# ðŸ’¬ )
# ðŸ’¬
# ðŸ’¬ for item in deleted_items {
# ðŸ’¬ {{ dataset_name }}.hard_delete(item.id)
# ðŸ’¬ log.info(f"Permanently deleted item {item.id}")
# ðŸ’¬ }
# ðŸ’¬ }
# ðŸ’¬ }
