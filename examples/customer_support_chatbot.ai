# Customer Support Chatbot
# Production-ready chatbot with memory, context awareness, and escalation

app "Customer Support Bot"

# ============================================================================
# LLM Configuration
# ============================================================================

model support_bot:
    provider: openai
    name: "gpt-4"
    temperature: 0.7
    max_tokens: 500

# ============================================================================
# Memory Stores
# ============================================================================

memory "conversation_history":
    scope: conversation
    kind: conversation
    max_items: 50

memory "customer_context":
    scope: session
    kind: key_value

memory "support_metrics":
    scope: global
    kind: key_value

# ============================================================================
# Knowledge Base (simulated with connector)
# ============================================================================

connector "knowledge_base":
    type: rest
    options:
        endpoint: "https://api.example.com/kb/search"
        method: get

# ============================================================================
# AI Chains
# ============================================================================

# Main conversation chain
chain "chat_response":
    inputs:
        message: text
        history: conversation
    
    steps:
        - step analyze_intent:
            model: support_bot
            prompt: |
                Analyze this customer message for intent and urgency.
                
                Message: {{message}}
                
                Recent history:
                {{history}}
                
                Classify:
                - intent: question, complaint, request, feedback, greeting
                - urgency: low, medium, high, critical
                - topic: billing, technical, account, shipping, other
                - needs_human: true/false
            output: intent_analysis
        
        - step search_knowledge:
            connector: knowledge_base
            query: "{{intent_analysis.topic}} {{message}}"
            output: kb_results
        
        - step generate_response:
            model: support_bot
            prompt: |
                You are a helpful customer support agent.
                
                Customer message: {{message}}
                Intent: {{intent_analysis.intent}}
                Topic: {{intent_analysis.topic}}
                
                Knowledge base results:
                {{kb_results}}
                
                Conversation history:
                {{history}}
                
                Generate a helpful, empathetic response. If you cannot help,
                suggest escalating to a human agent.
            output: response
        
        - step update_metrics:
            output: final_response
            value: |
                {{response}}

# Escalation chain
chain "escalate_to_human":
    inputs:
        conversation_id: text
        reason: text
    
    steps:
        - step create_ticket:
            prompt: |
                Create support ticket for conversation {{conversation_id}}
                Reason: {{reason}}
            output: ticket
        
        - step notify_agent:
            output: notification
            value: "Agent notified. Ticket #{{ticket.id}}"

# ============================================================================
# Pages
# ============================================================================

page "Chat" at "/":
    # Page title
    show text "Customer Support Chat" style {
        fontSize: "24px"
        fontWeight: "bold"
        marginBottom: "20px"
    }
    
    # Chat history
    show list from memory "conversation_history":
        loading: "Loading chat history..."
        empty: "Start a conversation by typing a message below."
        
        item:
            show card:
                body:
                    show text "{{role}}: {{content}}" style {
                        padding: "12px"
                        borderRadius: "8px"
                        marginBottom: "8px"
                        background: "{{role == 'user' ? '#e3f2fd' : '#f5f5f5'}}"
                    }
    
    # Input form
    show form "Send Message":
        field "user_message" type textarea placeholder "Type your message..." required rows 3
        button "Send"
        
        on submit:
            run chain "chat_response" with {
                message: "{{user_message}}",
                history: "{{conversation_history}}"
            }
            show toast "Message sent!"
    
    # Quick actions
    show text "Quick Actions" style {
        fontSize: "16px"
        fontWeight: "bold"
        marginTop: "30px"
        marginBottom: "10px"
    }
    
    show text "Talk to Human Agent" style {
        display: "inline-block"
        padding: "10px 20px"
        background: "#f59e0b"
        color: "white"
        borderRadius: "6px"
        cursor: "pointer"
        marginRight: "10px"
    }
    
    show text "Clear Chat" style {
        display: "inline-block"
        padding: "10px 20px"
        background: "#6b7280"
        color: "white"
        borderRadius: "6px"
        cursor: "pointer"
    }

# Agent Dashboard
page "Dashboard" at "/dashboard":
    navbar:
        title: "Support Dashboard"
        position: "top"
    
    show text "Active Conversations" style {
        fontSize: "24px"
        fontWeight: "bold"
        marginBottom: "20px"
    }
    
    show text "Total chats today: {{support_metrics.total_chats}}" style {
        fontSize: "16px"
        marginBottom: "10px"
    }
    
    show text "Average response time: {{support_metrics.avg_response_time}}s" style {
        fontSize: "16px"
        marginBottom: "10px"
    }
    
    show text "Escalations: {{support_metrics.escalations}}" style {
        fontSize: "16px"
        marginBottom: "20px"
    }

# ============================================================================
# Actions
# ============================================================================

action "escalate" when clicks "Talk to Human Agent":
    run chain "escalate_to_human" with {
        conversation_id: "{{session.id}}",
        reason: "Customer requested human agent"
    }
    show toast "Escalating to human agent..."

action "clear_chat" when clicks "Clear Chat":
    show toast "Chat cleared!"
